steps:
  - id: Setup Script
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk:slim"
    entrypoint: /bin/bash
    args:
      - "-c"
      - |
        source ./experimental/run_test.sh terraform ${_CI_PROJECT} ${_PARENT_FOLDER}

  - id: "build"
    name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "gcr.io/${_CI_PROJECT}/${_SERVICE}", "."]

  - id: "push"
    name: "gcr.io/cloud-builders/docker"
    args: ["push", "gcr.io/${_CI_PROJECT}/${_SERVICE}"]

  - id: "tf"
    name: "hashicorp/terraform:${_TF_VERSION}"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        cd terraform
        terraform init
        terraform plan -var project=${_CI_PROJECT}
        terraform apply -auto-approve -var project=${_CI_PROJECT}

  - id: "migrate"
    name: "gcr.io/google-appengine/exec-wrapper"
    args:
      [
        "-i",
        "gcr.io/${_CI_PROJECT}/${_SERVICE}",
        "-s",
        "${_CI_PROJECT}:${_REGION}:${_INSTANCE_NAME}",
        "-e",
        "PROJECT_ID=${_CI_PROJECT}",
        "--",
        "sh",
        ".cloudbuild/django_migrate.sh",
      ]

  - id: "system test"
    name: $_PYTHON_VERSION
    entrypoint: /bin/bash
    args:
      - "-c"
      - |
        python -m pip install -r .util/requirements.txt
        .util/helper check-deploy $_CI_PROJECT

  - id: "tf destroy"
    name: "hashicorp/terraform:${_TF_VERSION}"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        cd terraform
        terraform destroy -auto-approve -var project=${_CI_PROJECT}

  - id: "project destroy"
    name: "google/cloud-sdk"
    entrypoint: /bin/bash
    args:
      - "-c"
      - |
        gcloud projects delete $_CI_PROJECT --quiet

substitutions:
  _SERVICE: unicodex
  _TF_VERSION: 0.15.4
  _PYTHON_VERSION: python:3.9-slim
  _REGION: us-central1
  _INSTANCE_NAME: postgres
  _PARENT_FOLDER: "440127642793"
  _CI_PROJECT: "unicodex-ci-${BUILD_ID:0:8}-terraform"

logsBucket: unicodex-ci-base-buildlogs
serviceAccount: projects/unicodex-ci-base/serviceAccounts/ci-serviceaccount@unicodex-ci-base.iam.gserviceaccount.com

options:
  dynamic_substitutions: true
